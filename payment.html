<html>
<head>
    <script language="JavaScript">
        // Function to get a parameter value from the URL
        function getUrlParameter(name) {
            var urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);  // Return the value of the parameter
        }

        // Listen for the message from the iframe (for card payments)
        window.addEventListener('message', function(event) {
            try {
                // Ensure the message comes from the Fiserv iframe's domain
                if (event.origin !== "https://fts-uat.cardconnect.com") {
                    console.error("Invalid origin: " + event.origin);
                    return;
                }

                // Parse the token message received from the iframe
                var token = JSON.parse(event.data);
                if (token && token.message) {
                    // Store the token in a hidden input field
                    var mytoken = document.getElementById('mytoken');
                    mytoken.value = token.message;
                }
            } catch (error) {
                console.error("Error parsing token: ", error);
            }
        }, false);

        // Function to submit the form to the webhook
        function submitToWebhook() {
            // Get the token, routing/account numbers, and invoice ID from the hidden fields or form
            var token = document.getElementById('mytoken') ? document.getElementById('mytoken').value : '';
            var invoiceId = document.getElementById('invoiceId').value;
            var companyId = getUrlParameter('companyId');  // Get companyId from the URL
            var saveCard = document.getElementById('saveCard') ? document.getElementById('saveCard').checked : false;  // Get the value of "Save card on file" checkbox
            var routingNumber = document.getElementById('routingNumber') ? document.getElementById('routingNumber').value : '';
            var accountNumber = document.getElementById('accountNumber') ? document.getElementById('accountNumber').value : '';
            var payType = getUrlParameter('payType');  // Get payType from the URL

            console.log("Token:", token);  // Debugging
            console.log("Invoice ID:", invoiceId);  // Debugging
            console.log("Company ID:", companyId);  // Debugging
            console.log("Save card on file:", saveCard);  // Debugging
            console.log("Routing Number:", routingNumber);  // Debugging
            console.log("Account Number:", accountNumber);  // Debugging

            if (!invoiceId) {
                alert("Invoice ID is missing.");
                return;
            }

            if (!companyId) {
                alert("Company ID is missing.");
                return;
            }

            // Prepare data based on the payment method selected
            var data = {
                invoiceId: invoiceId,  // Include the invoice ID in the data sent to the webhook
                companyId: companyId,   // Include the company ID in the data sent to the webhook
                payType: payType       // Include the payType in the payload
            };

            if (payType === 'card') {
                // Card payment selected
                if (!token) {
                    alert("Card token is required.");
                    return;
                }
                data.token = token;
                data.saveCard = saveCard;  // Include the save card on file checkbox value
            } else if (payType === 'cof') {
                // COF (Card on File) selected
                data.totalAmount = document.getElementById('totalAmount').innerText;
            } else if (routingNumber && accountNumber) {
                // ACH payment setup selected
                data.routingNumber = routingNumber;
                data.accountNumber = accountNumber;
            } else {
                alert("Please provide required payment information.");
                return;
            }

            // Perform the POST request to the webhook
            fetch("https://internalwf.zuper.co/webhook/0438eddc-d897-4a67-b4c4-3dbb87c82781", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(responseData => {
                console.log("Webhook response:", responseData);
                alert("Webhook called successfully.");
            })
            .catch(error => {
                console.error("Error calling webhook:", error);
                alert("Error submitting data to webhook.");
            });
        }

        // On page load, check the payment type and toggle the appropriate section
        window.onload = function() {
            var invoiceId = getUrlParameter('invoiceId');
            var companyId = getUrlParameter('companyId');
            var payType = getUrlParameter('payType');

            console.log("Invoice ID from URL:", invoiceId);  // Log for debugging
            console.log("Company ID from URL:", companyId);  // Log for debugging
            console.log("PayType from URL:", payType);  // Log for debugging

            if (invoiceId) {
                document.getElementById('invoiceId').value = invoiceId;
                console.log("Invoice ID assigned to hidden input:", document.getElementById('invoiceId').value);
            } else {
                console.error("Invoice ID not found in URL.");
            }

            if (companyId) {
                console.log("Company ID extracted successfully");
            } else {
                console.error("Company ID not found in URL.");
            }

            if (payType === 'card') {
                // Card payment selected, show the card payment flow
                togglePaymentMethod('card');
            } else if (payType === 'cof') {
                // Card on File selected, hide the payment forms and show confirmation
                togglePaymentMethod('cof');
            } else {
                // Default to card payment if no payType is specified
                togglePaymentMethod('card');
            }
        };

        // Function to toggle the visibility of payment method options
        function togglePaymentMethod(method) {
            if (method === 'card') {
                // Show card payment options (iframe, checkbox)
                document.getElementById('cardPaymentSection').style.display = 'block';
                document.getElementById('saveCardLabel').style.display = 'block';
                document.getElementById('routingFields').style.display = 'none';  // Hide ACH fields
                document.getElementById('confirmationSection').style.display = 'none'; // Hide confirmation for COF
            } else if (method === 'ach') {
                // Hide card payment options and show ACH fields
                document.getElementById('cardPaymentSection').style.display = 'none';
                document.getElementById('saveCardLabel').style.display = 'none';
                document.getElementById('routingFields').style.display = 'block';  // Show ACH fields
                document.getElementById('confirmationSection').style.display = 'none'; // Hide confirmation for COF
            } else if (method === 'cof') {
                // Hide card/ACH payment options and show confirmation message
                document.getElementById('cardPaymentSection').style.display = 'none';
                document.getElementById('saveCardLabel').style.display = 'none';
                document.getElementById('routingFields').style.display = 'none'; // Hide ACH fields
                document.getElementById('confirmationSection').style.display = 'block'; // Show COF confirmation
            }
        }
    </script>
</head>
<body>
    <h1>Payment Method Selection</h1>
    
    <!-- Payment Method Selection -->
    <form name="paymentForm" id="paymentForm">
        <!-- Hidden field to store the Zuper invoice ID -->
        <input type="hidden" name="invoiceId" id="invoiceId" />

        <!-- Card Payment: Tokenization iframe and Save Card checkbox -->
        <div id="cardPaymentSection">
            <iframe id="tokenFrame" name="tokenFrame" src="https://fts-uat.cardconnect.com/itoke/ajax-tokenizer.html?useexpiry=true&usecvv=true" frameborder="0" scrolling="no" width="400" height="150"></iframe>
            <br><br>
            <label id="saveCardLabel" style="display: block;">
                <input type="checkbox" id="saveCard" /> Save card on file
            </label>
        </div>

        <!-- ACH Payment: Routing number and Account number input fields -->
        <div id="routingFields" style="display: none;">
            <br><br>
            <label>Routing Number:</label>
            <input type="text" id="routingNumber" name="routingNumber" />
            <br><br>
            <label>Account Number:</label>
            <input type="text" id="accountNumber" name="accountNumber" />
        </div>

        <!-- Confirmation Section for COF (Card on File) -->
        <div id="confirmationSection" style="display: none;">
            <p id="totalAmount">Your invoice amount is $100 and applicable surcharge is $3.</p>
            <p>Total transaction amount $103. Please click on the button below to confirm payment.</p>
            <button type="button" onclick="submitToWebhook()">Confirm Payment</button>
        </div>
    </form>
</body>
</html>
